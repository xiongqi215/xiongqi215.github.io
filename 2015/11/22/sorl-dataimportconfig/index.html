<!DOCTYPE html><html><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><title> Solr-data-config.xml配置 · 非典型性程序猿</title><meta name="description" content="Solr-data-config.xml配置 - Justin"><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="short icon" href="/favicon.png"><link rel="stylesheet" href="/css/apollo.css"><link rel="search" type="application/opensearchdescription+xml" href="http://www.justin-x.cn/atom.xml" title="非典型性程序猿"></head><body><div class="wrap"><header><a href="/" class="logo-link"><img src="/favicon.png"></a><ul class="nav nav-list"><li class="nav-list-item"><a href="/" target="_self" class="nav-list-link">BLOG</a></li><li class="nav-list-item"><a href="/archives/" target="_self" class="nav-list-link">ARCHIVE</a></li><li class="nav-list-item"><a href="http://weibo.com/sunchongsheng" target="_blank" class="nav-list-link">WEIBO</a></li><li class="nav-list-item"><a href="https://github.com/pinggod" target="_blank" class="nav-list-link">GITHUB</a></li><li class="nav-list-item"><a href="/atom.xml" target="_self" class="nav-list-link">RSS</a></li></ul></header><section class="container"><div class="post"><article class="post-block"><h1 class="post-title">Solr-data-config.xml配置</h1><div class="post-info">Nov 22, 2015</div><div class="post-content"><p>data-config.xml位于core目录/conf/目录下，用于配置从指定数据中查询数据并导入索引。<br>配置如下：<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">dataConfig</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">dataSource</span> <span class="attr">name</span>=<span class="string">"jdbcDataSource"</span> <span class="attr">type</span>=<span class="string">"JdbcDataSource"</span> </span></div><div class="line">    <span class="attr">driver</span>=<span class="string">"oracle.jdbc.driver.OracleDriver"</span></div><div class="line">    <span class="attr">url</span>=<span class="string">"jdbc:oracle:thin:@localhost:1521:orcl"</span> </div><div class="line">    <span class="attr">user</span>=<span class="string">"finc"</span> <span class="attr">password</span>=<span class="string">"password"</span>/&gt;</div><div class="line">    <span class="tag">&lt;<span class="name">document</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">entity</span> <span class="attr">dataSource</span>=<span class="string">"jdbcDataSource"</span> <span class="attr">name</span>=<span class="string">"country"</span>  </span></div><div class="line">        <span class="attr">query</span>=<span class="string">"select * from t_base_country"</span> &gt;</div><div class="line">            <span class="tag">&lt;<span class="name">field</span> <span class="attr">column</span>=<span class="string">"ID"</span> <span class="attr">name</span>=<span class="string">"id"</span>&gt;</span><span class="tag">&lt;/<span class="name">field</span>&gt;</span></div><div class="line">            <span class="tag">&lt;<span class="name">field</span> <span class="attr">column</span>=<span class="string">"NAME_CN"</span> <span class="attr">name</span>=<span class="string">"nameCn"</span>&gt;</span><span class="tag">&lt;/<span class="name">field</span>&gt;</span> </div><div class="line">            <span class="tag">&lt;<span class="name">field</span> <span class="attr">column</span>=<span class="string">"NAME_EN"</span> <span class="attr">name</span>=<span class="string">"nameEn"</span>&gt;</span><span class="tag">&lt;/<span class="name">field</span>&gt;</span> </div><div class="line">            <span class="tag">&lt;<span class="name">field</span> <span class="attr">column</span>=<span class="string">"CONTINENTS_CN"</span> <span class="attr">name</span>=<span class="string">"continentsCn"</span>&gt;</span><span class="tag">&lt;/<span class="name">field</span>&gt;</span></div><div class="line">            <span class="tag">&lt;<span class="name">field</span> <span class="attr">column</span>=<span class="string">"CONTINENTS_EN"</span> <span class="attr">name</span>=<span class="string">"continentsEn"</span>&gt;</span><span class="tag">&lt;/<span class="name">field</span>&gt;</span></div><div class="line">            <span class="tag">&lt;<span class="name">field</span> <span class="attr">column</span>=<span class="string">"CN_FIRST_LETTER"</span> <span class="attr">name</span>=<span class="string">"cnFirstLetter"</span>&gt;</span><span class="tag">&lt;/<span class="name">field</span>&gt;</span></div><div class="line">            <span class="tag">&lt;<span class="name">field</span> <span class="attr">column</span>=<span class="string">"EN_FIRST_LETTER"</span> <span class="attr">name</span>=<span class="string">"enFirstLetter"</span>&gt;</span><span class="tag">&lt;/<span class="name">field</span>&gt;</span></div><div class="line">            <span class="tag">&lt;<span class="name">field</span> <span class="attr">column</span>=<span class="string">"SORT"</span> <span class="attr">name</span>=<span class="string">"sort"</span>&gt;</span><span class="tag">&lt;/<span class="name">field</span>&gt;</span></div><div class="line">        <span class="tag">&lt;/<span class="name">entity</span>&gt;</span></div><div class="line">    <span class="tag">&lt;/<span class="name">document</span>&gt;</span></div><div class="line">  <span class="tag">&lt;/<span class="name">dataConfig</span>&gt;</span></div></pre></td></tr></table></figure></p>
<a id="more"></a>
<h2 id="dataSource节点配置："><a href="#dataSource节点配置：" class="headerlink" title="dataSource节点配置："></a><code>dataSource</code>节点配置：</h2><ul>
<li><code>name</code>: dataSource的名称，配置文件可以有多个datasource，使用name区分。</li>
<li><code>type</code>:数据源类型，如JDBC</li>
<li><code>driver</code>:数据库驱动包，去提前放到lib目录下</li>
<li><code>url</code>:数据库连接url</li>
<li><code>user</code>:数据库用户名</li>
<li><code>password</code>:数据库密码</li>
<li><code>&lt;field&gt;</code>字段配置：<ul>
<li><code>column</code>:数据库查询列名称</li>
<li><code>name</code>:Schema.xml中的字段</li>
</ul>
</li>
</ul>
<h2 id="doucment节点配置"><a href="#doucment节点配置" class="headerlink" title="doucment节点配置"></a><code>doucment</code>节点配置</h2><p><code>document</code>节点用来配置如何从数据库导入数据构建document对象,主要有一个或多个<code>&lt;entity&gt;</code>即实体组成。<code>&lt;entity&gt;</code>有如下属性：</p>
<ul>
<li><code>name</code>:实体名称</li>
<li><code>dataSource</code>:dataSource名称</li>
<li><code>query</code>:获取全部数据的SQL</li>
<li><code>deltaImportQuery</code>:获取增量数据时使用的SQL</li>
<li><code>deltaQuery</code>:获取pk的SQL</li>
<li><code>parentDeltaQuery</code>:获取父Entity的pk的SQL</li>
</ul>
<p>在Solr的控制台上可执行：<code>full-import</code>全导入和<code>delta-import</code>增量导入。</p>
<p><strong>Full Import工作原理：</strong><br>执行本Entity的Query，获取所有数据；<br>针对每个行数据Row，获取pk，组装子Entity的Query；<br>执行子Entity的Query，获取子Entity的数据。</p>
<p><strong>Delta Import工作原理：</strong><br>查找子Entity，直到没有为止；<br>执行Entity的deltaQuery，获取变化数据的pk；<br>合并子Entity parentDeltaQuery得到的pk；<br>针对每一个pk Row，组装父Entity的parentDeltaQuery；<br>执行parentDeltaQuery，获取父Entity的pk；<br>执行deltaImportQuery，获取自身的数据；<br>如果没有deltaImportQuery，就组装Query</p>
<p><strong>限制：</strong><br>子Entity的query必须引用父Entity的pk<br>子Entity的parentDeltaQuery必须引用自己的pk<br>子Entity的parentDeltaQuery必须返回父Entity的pk<br>deltaImportQuery引用的必须是自己的pk</p>
<p>solr自带的实例配置：<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">dataConfig</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">dataSource</span> <span class="attr">driver</span>=<span class="string">"org.hsqldb.jdbcDriver"</span> </span></div><div class="line">      <span class="attr">url</span>=<span class="string">"jdbc:hsqldb:E:/solr_home/hsqldb/ex"</span> <span class="attr">user</span>=<span class="string">"sa"</span> /&gt;</div><div class="line">    <span class="tag">&lt;<span class="name">document</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">entity</span> <span class="attr">name</span>=<span class="string">"item"</span> <span class="attr">query</span>=<span class="string">"select * from item"</span></span></div><div class="line">             <span class="attr">deltaQuery</span>=<span class="string">"select id from item where last_modified &gt; '$&#123;dataimporter.last_index_time&#125;'"</span>&gt;</div><div class="line">            <span class="tag">&lt;<span class="name">field</span> <span class="attr">column</span>=<span class="string">"NAME"</span> <span class="attr">name</span>=<span class="string">"name"</span> /&gt;</span></div><div class="line"></div><div class="line">            <span class="tag">&lt;<span class="name">entity</span> <span class="attr">name</span>=<span class="string">"feature"</span>  </span></div><div class="line">                    <span class="attr">query</span>=<span class="string">"select DESCRIPTION from FEATURE where ITEM_ID='$&#123;item.ID&#125;'"</span></div><div class="line">                    <span class="attr">deltaQuery</span>=<span class="string">"select ITEM_ID from FEATURE where last_modified &gt; '$&#123;dataimporter.last_index_time&#125;'"</span></div><div class="line">                    <span class="attr">parentDeltaQuery</span>=<span class="string">"select ID from item where ID=$&#123;feature.ITEM_ID&#125;"</span>&gt;</div><div class="line">                <span class="tag">&lt;<span class="name">field</span> <span class="attr">name</span>=<span class="string">"features"</span> <span class="attr">column</span>=<span class="string">"DESCRIPTION"</span> /&gt;</span></div><div class="line">            <span class="tag">&lt;/<span class="name">entity</span>&gt;</span></div><div class="line">            </div><div class="line">            <span class="tag">&lt;<span class="name">entity</span> <span class="attr">name</span>=<span class="string">"item_category"</span></span></div><div class="line">                    <span class="attr">query</span>=<span class="string">"select CATEGORY_ID from item_category where ITEM_ID='$&#123;item.ID&#125;'"</span></div><div class="line">                    <span class="attr">deltaQuery</span>=<span class="string">"select ITEM_ID, CATEGORY_ID from item_category where last_modified &gt; '$&#123;dataimporter.last_index_time&#125;'"</span></div><div class="line">                    <span class="attr">parentDeltaQuery</span>=<span class="string">"select ID from item where ID=$&#123;item_category.ITEM_ID&#125;"</span>&gt;</div><div class="line">                <span class="tag">&lt;<span class="name">entity</span> <span class="attr">name</span>=<span class="string">"category"</span></span></div><div class="line">                        <span class="attr">query</span>=<span class="string">"select DESCRIPTION from category where ID = '$&#123;item_category.CATEGORY_ID&#125;'"</span></div><div class="line">                        <span class="attr">deltaQuery</span>=<span class="string">"select ID from category where last_modified &gt; '$&#123;dataimporter.last_index_time&#125;'"</span></div><div class="line">                        <span class="attr">parentDeltaQuery</span>=<span class="string">"select ITEM_ID, CATEGORY_ID from item_category where CATEGORY_ID=$&#123;category.ID&#125;"</span>&gt;</div><div class="line">                    <span class="tag">&lt;<span class="name">field</span> <span class="attr">column</span>=<span class="string">"DESCRIPTION"</span> <span class="attr">name</span>=<span class="string">"cat"</span> /&gt;</span></div><div class="line">                <span class="tag">&lt;/<span class="name">entity</span>&gt;</span></div><div class="line">            <span class="tag">&lt;/<span class="name">entity</span>&gt;</span></div><div class="line">        <span class="tag">&lt;/<span class="name">entity</span>&gt;</span></div><div class="line">    <span class="tag">&lt;/<span class="name">document</span>&gt;</span>    </div><div class="line"><span class="tag">&lt;/<span class="name">dataConfig</span>&gt;</span></div></pre></td></tr></table></figure></p>
<p><strong>注意查询条件的写法：${..},如在本例中：</strong></p>
<p><strong>${dataimporter.last_index_time}  索引上次导入时间</strong></p>
<p><strong>${item.ID}  实体item查询结果中的ID</strong></p>
</div></article></div></section><footer><div class="paginator"><a href="/2015/11/22/sorl-envbuild/" class="prev">PREV</a><a href="/2015/11/22/solr-intro/" class="next">NEXT</a></div><div data-thread-key="2015/11/22/sorl-dataimportconfig/" data-title="Solr-data-config.xml配置" data-url="http://www.justin-x.cn/2015/11/22/sorl-dataimportconfig/" data-author-key="1" class="ds-thread"></div><script>var duoshuoQuery = {short_name:"Justin-Blog"};
(function() {
    var ds = document.createElement('script');
    ds.type = 'text/javascript';ds.async = true;
    ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.js';
    ds.charset = 'UTF-8';
    (document.getElementsByTagName('head')[0] 
     || document.getElementsByTagName('body')[0]).appendChild(ds);
})();

</script><div class="copyright"><p>© 2015 - 2016 <a href="http://www.justin-x.cn">Justin</a>, powered by <a href="https://hexo.io/" target="_blank">Hexo</a> and <a href="https://github.com/pinggod/hexo-theme-apollo" target="_blank">hexo-theme-apollo</a>.</p></div></footer></div><script async src="//cdn.bootcss.com/mathjax/2.6.1/MathJax.js?config=TeX-MML-AM_CHTML"></script></body></html>